---
title: "Regression with R"
author: "Paulo Fagandini, Marlon Francisco, and Diogo Franquinho"
institute: "Nova School of Business and Economics"
format: 
  revealjs:
    theme:
      - default
    self-contained: false
    logo: pictures/NovaPrincipalV2.svg
    slide-number: true
    cross-ref: true
    incremental: true
    math: 
      method: mathjax
    transition: slide
    footer: "Economics"
    from: markdown+emoji
    code-overflow: wrap
    code-block-font-size: 0.75em
    progress: true
editor: source
execute:
  enabled: true
engine: knitr
---

## The first thing to do

The first thing to do is to clean the environment

```{r}
#| echo: true
#| eval: false

rm(list = ls())
```

> Use with CAUTION: this will delete everything in your environment

## Load libraries

You do not need to this immediately, but it is good practice. For this lecture, we need to load the following packages:

```{r}
#| echo: true
#| eval: false

library(tidyverse)
library(stargazer)
library(skimr)
library(caret)
library(xtable)
library(GGally)
library(ggthemes)
library(car)
```

## Install libraries
If you fail to load one of these libraries, you can install it with:

```{r}
#| echo: true
#| eval: false

install.packages{'tidyverse'}
```
For example, with this we install the library **tidyverse**

## Set working directory

In here, we will tell R where our files (data) are, and by default, where it will store any file we might want to export (images for example.)

```{r}
#| echo: true
#| eval: false

setwd("/the/path/to/your/files")
```

## Load and work data
```{r}
#| echo: true
#| eval: false

DM <- read.csv('DirectMarketing.csv')
skim_without_charts(DM)
DM$History[is.na(DM$History)] <- "No past purchases"
DM$PastPurchases <- ifelse(DM$History == "No past purchases",
    "No past purchases", "Past purchases")
```

## Quick summary statistics table

```{r}
#| echo: true
#| eval: false

stargazer(as.data.frame(DM), type = "text", title="Descriptive stats")
stargazer(as.data.frame(DM), type = "html",
    title="Descriptive stats", out="DS.html")
```

## If you have non-numeric data

```{r}
#| echo: true
#| eval: false

DM_aux <- dummyVars(" ~ .", data = DM)
DM_num <- data.frame(predict(DM_aux, newdata = DM))
stargazer(as.data.frame(DM_num), type = "text", 
          title="Descriptive stats: all numeric data")

stargazer(as.data.frame(DM_num), type = "html", 
          title="Descriptive stats: all numeric data",
          out="DS2.html")
```

## Correlation matrix
```{r}
#| echo: true
#| eval: false

corrDM = cor(DM[,c("AmountSpent", "Salary", "Catalogs", "Children")])

stargazer(corrDM, title="Correlation Matrix", 
          digits = 2, type="text")

stargazer(corrDM, title="Correlation Matrix", 
          digits = 2, type="html",
          out="corr.html")
```

## Histogram

```{r}
#| echo: true
#| eval: false

ggplot(data = DM, aes(x = AmountSpent)) +
    geom_histogram()
ggplot(data = DM, aes(x = Salary)) +
    geom_histogram()
ggplot(data = DM, aes(x = Catalogs)) +
    geom_histogram()
ggplot(data = DM, aes(x = Children)) +
    geom_histogram()

```

## Data distribution

```{r}
#| echo: true
#| eval: false

ggplot(data = DM, aes(x = factor(Gender), y = AmountSpent)) +
    geom_boxplot() + 
    theme(text = element_text(size = 25))
ggplot(data = DM, aes(x = factor(Location), y = AmountSpent)) +
    geom_boxplot() +
    theme(text = element_text(size = 25))
ggplot(data = DM, aes(x = factor(Age), y = AmountSpent)) +
    geom_boxplot() +
    theme(text = element_text(size = 25))
ggplot(data = DM, aes(x = factor(History), y = AmountSpent)) +
    geom_boxplot() +
    theme(text = element_text(size = 25))
```

## Scatterplots
```{r}
#| echo: true
#| eval: false

ggplot(data = DM, aes(x = Salary, y = AmountSpent)) +
    geom_point() + 
    stat_smooth(method = lm) +
    theme(text = element_text(size = 18))
```

## Linear Regression
```{r}
#| echo: true
#| eval: false

lm1 <- lm(AmountSpent ~ Salary, data = DM)

stargazer(lm1, type = "text", no.space = TRUE, digits=3, 
          title = "Impact of Salary on Amount Spent")

stargazer(lm1, type = "html", no.space = TRUE, digits=3, 
          title = "Impact of Salary on Amount Spent",
          out="SLR.html")
```

## Work with the coefficients
```{r}
#| echo: true
#| eval: false

lm1.coeffs <- coefficients(lm1)
lm1.coeffs

lm1.coeffs[1] + lm1.coeffs[2]*100000
```

## Predicted values ($\hat{y}$, $\hat{u}$)
This add a new variable to our original dataset:
```{r}
#| echo: true
#| eval: false

DM$lm1_y = predict(lm1)
DM$lm1_u = residuals(lm1)
```

## Linear regression with more htan one variable

You can store the models, and estimate them later.

```{r}
#| echo: true
#| eval: false

m1 <- AmountSpent ~ Salary 
m2 <- AmountSpent ~ Salary + Catalogs + Children 
m3 <- AmountSpent ~ Salary + Catalogs + Children +
    Gender + History + Location
```

## Estimate models
```{r}
#| echo: true
#| eval: false

lm.spend1 <- lm(m1, data = DM)
lm.spend2 <- lm(m2, data = DM)
lm.spend3 <- lm(m3, data = DM)
```

## Output table with Models 1 to 3
```{r}
#| echo: true
#| eval: false

stargazer(lm.spend1, lm.spend2, lm.spend3, 
          header = FALSE , type = "text", column.sep.width = "1pt", 
          no.space = TRUE, df = FALSE, digits = 2, 
          title = "Regression Analysis - Determinants of Amount Spent")

stargazer(lm.spend1, lm.spend2, lm.spend3, 
          header = FALSE , type = "html", column.sep.width = "1pt", 
          no.space = TRUE, df = FALSE, digits = 2, 
          title = "Regression Analysis - Determinants of Amount Spent",
          out="MLR.html")
```

## Running some tests on the models:
```{r}
#| echo: true
#| eval: false

linearHypothesis(lm.spend2, c("Salary=0"))
linearHypothesis(lm.spend2, c("4*Catalogs=-Children"))
linearHypothesis(lm.spend2, c("Catalogs=0","Children=0"))
```